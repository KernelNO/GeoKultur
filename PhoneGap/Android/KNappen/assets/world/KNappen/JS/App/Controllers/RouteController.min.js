var App,routeController;(function(n){(function(t){var u=function(){function n(){this.name=null,this.id=null,this.data=null,this.adminPwd=null}return n}(),i,r;t.RouteControllerRequest=u,i=function(){function n(){this.routes=[]}return n}(),t.RouteIndex=i,r=function(){function t(){this.routeProvider=new n.Providers.RouteProvider}return t.prototype.PostInit=function(){log.debug("RouteController","PostInit()")},t.prototype.Init=function(){log.debug("RouteController","Init()");var n=this;viewController.addSelectEvent(function(t,i,r){r.name=="routeView"&&n.renderRouteView()}),this.routeProvider.adminRoutes.loadRoutes(),this.routeProvider.userRoutes.loadRoutes(),this.routeProvider.searchRoutes.loadRoutes(),this.startAdminRouteDownload(),$("#btnCache").mousedown(function(){n.cacheRoute(n.routeProvider.searchRoutes),n.cacheRoute(n.routeProvider.userRoutes),n.cacheRoute(n.routeProvider.adminRoutes)})},t.prototype.cacheRoute=function(n){var t=this;$.each(n.getRoutes(),function(n,t){$.each(t.pois(),function(n,t){mapPreCacheProvider.cachePos(t.pos())})})},t.prototype.addSearchRoute=function(t,i){log.debug("RouteController","Adding search result to new route: "+t);var r=new n.Providers.RouteItem;r.name(t),r.version(r.version()+1),$.each(i,function(n,t){r.pois.push(t)}),this.routeProvider.userRoutes.addRoute(r),this.routeProvider.userRoutes.saveRoutes()},t.prototype.createRoute=function(t,i){var r=new n.Providers.RouteItem;r.name(t),r.version(r.version()+1),this.routeProvider.userRoutes.addRoute(r),this.routeProvider.userRoutes.saveRoutes(),userPopupController.sendSuccess(tr.translate("Route created"),tr.translate("The route '{0}' was created.",[t])),i?this.openRouteList(i):this.renderRouteView()},t.prototype.openRouteList=function(n){var t=$("#listExistingRoutes");t.empty(),routeController.routeProvider.userRoutes.getRoutes().forEach(function(i){t.append("<li class='routeName' id='route_"+i.id()+"'><h3>"+i.name()+"<\/h3><\/li>"),$("#route_"+i.id()).mousedown(function(){i.pois.push(n),routeController.routeProvider.userRoutes.saveRoutes(),$("#addPoiToRouteForm").hide()})})},t.prototype.renderRouteView=function(){var t=$("#editorialRoutes"),i=$("#userRoutes"),n;t.empty(),i.empty(),n=this,routeController.routeProvider.adminRoutes.getRoutes().forEach(function(i){var r="routeSelect_"+i.id(),u="routeEdit_"+i.id(),f="routeUnpublish_"+i.id();t.append('<li class="routeListItem" id="routeListItem_'+i.id()+'"><h2>'+i.name()+'<\/h2><input type="button" value="'+tr.translate("Follow route")+'" id="'+r+'"/><input type="button" value="'+tr.translate("Edit")+'" id="'+u+'"/><\/li>'),$("#"+r).mousedown(function(){n.selectRoute(i)}),$("#"+u).mousedown(function(){resultListController.renderView(resultListController,i.pois(),i.id()),viewController.selectView("listView")}),$("#"+f).mousedown(function(){})}),routeController.routeProvider.userRoutes.getRoutes().forEach(function(t){var r="routeSelect_"+t.id(),u="routeEdit_"+t.id(),f="routePublish_"+t.id(),s="Pwd_"+f,e="Btn_"+f,h="Pwd_"+t.id(),o="";settings.adminPassword()&&settings.adminPassword().substring(0,3)=="Kul"&&(o='<input type="button" value="Publiser" id="'+e+'"/>'),i.append('<li class="routeListItem" id="routeListItem_'+t.id()+'">'+t.name()+'<br/><input type="button" value="'+tr.translate("Follow route")+'" id="'+r+'"/><input type="button" value="'+tr.translate("Edit")+'" id="'+u+'"/>'+o+"<\/li>"),$("#"+r).mousedown(function(){n.selectRoute(t)}),$("#"+u).mousedown(function(){viewController.selectView("listView"),resultListController.renderView(resultListController,t.pois(),t.id())}),$("#"+e).mousedown(function(){n.uploadAdminRoute(t,settings.adminPassword())})})},t.prototype.selectRoute=function(t){var i=new n.Models.SearchResult;i.items(t.pois()),i.numFound(t.pois().length),searchController.searchResultCallback(searchController,i),viewController.selectView(settings.startView())},t.prototype.updateRoute=function(n,t){var i=this.routeProvider.userRoutes.findRouteById(n);t.length>0?i.pois(t):(i.pois=ko.observableArray(),i.version(i.version()+1)),this.routeProvider.userRoutes.saveRoutes()},t.prototype.startAdminRouteDownload=function(){var t=this,i=new System.Providers.HttpDownloadItem("AdminRouteIndex",config.routeAdminIndexUrl+"?format=json",function(i){var r=new n.Controllers.RouteIndex;try{r=serializer.deserializeJSObject(i,r),routeController.routeProvider.adminRoutes.clearRoutes(),$.each(r.routes,function(n,i){try{var r=new System.Providers.HttpDownloadItem("AdminRoute:"+i,config.routeAdminDownloadUrl+"/"+i+"?format=json",function(n){t.processNewAdminRoute(n)},null,null,"json");httpDownloadProvider.enqueueItem("Route",System.Providers.HttpDownloadQueuePriority.Low,r)}catch(u){log.error("RouteController",'Exception route "'+i+'" index: '+u)}})}catch(u){log.error("RouteController","Exception deserializing route index: "+u)}});httpDownloadProvider.enqueueItem("Route",System.Providers.HttpDownloadQueuePriority.Low,i)},t.prototype.processNewAdminRoute=function(t){var i=new n.Providers.RouteItem,r;i=serializer.deserializeKnockoutObject(t.data,i),r=ko.observableArray(),$.each(i.pois(),function(t,i){var u=new n.Models.PointOfInterest;$.extend(u,i),u.pos=ko.observable(u.pos),r.push(u)}),i.pois=r,routeController.routeProvider.adminRoutes.addRoute(i),routeController.routeProvider.adminRoutes.saveRoutes()},t.prototype.uploadAdminRoute=function(t,i){var r=new n.Controllers.RouteControllerRequest,u;r.adminPwd=i,r.data=serializer.serializeKnockoutObject(t),r.id=t.id(),r.name=t.name(),u=serializer.serializeJSObject(r),$.ajax({url:config.adminRouteUrl,type:"POST",data:u,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,success:function(){userPopupController.sendSuccess(tr.translate("Published"),tr.translate("The route has been published."))},error:function(){userPopupController.sendError(tr.translate("Not published"),tr.translate("The route has not been published."))}})},t}(),t.RouteController=r})(n.Controllers||(n.Controllers={}));var t=n.Controllers})(App||(App={})),routeController=new App.Controllers.RouteController,startup.addInit(function(){routeController.Init()},"RouteController"),startup.addPostInit(function(){routeController.PostInit()},"RouteController")