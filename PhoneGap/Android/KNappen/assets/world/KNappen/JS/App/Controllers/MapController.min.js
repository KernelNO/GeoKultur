var App,mapController;(function(n){(function(t){var i=function(){function t(){this.mapProvider=null,this.panel=null}return t.prototype.PreInit=function(){log.debug("MapController","PreInit()"),this.mapProvider=new System.Providers.MapProvider},t.prototype.Init=function(){var u,i,f,n,r,t;log.debug("MapController","Init()"),$("#mapView").show(),u="map",i=this.mapProvider,i.Init(!1,u,settings.startMapType()),config.mapUseCache&&mapCacheProvider.addCacheToMap("standard",this.mapProvider.map),i.setCenter(config.mapStartPos,settings.startMapZoomLevel()),f=this.renderView,n=this,$("body").append('<div id="mapSearchDialog" title="'+tr.translate("Search for place")+'" class="bigDialog"><\/div>'),$("body").append('<div id="mapResultToRouteDialog" title="'+tr.translate("Create route from search")+'" class="bigDialog"><\/div>'),searchController.addSearchResultCallback(function(t,i){f(n,i)}),r=new OpenLayers.Control.Button({title:tr.translate("My position"),text:"<span class='typcn typcn-radar mapTypIconButton'><\/span>",trigger:function(){var t=gpsProvider.lastPos;t||(t=config.mapStartPos),n.mapProvider.setCenter(t,settings.startMapZoomLevel())}}),this.panel=new OpenLayers.Control.Panel({defaultControl:r,createControlMarkup:function(n){var t=document.createElement("button"),i=document.createElement("span"),r=document.createElement("span");return i.innerHTML="&nbsp;",t.appendChild(i),n.text&&(r.innerHTML=n.text),t.appendChild(r),t}}),this.panel.addControls([r,new OpenLayers.Control.ZoomIn({title:tr.translate("Zoom in"),text:"<span class='typcn typcn-plus mapTypIconButton'><\/span>"}),new OpenLayers.Control.ZoomOut({title:tr.translate("Zoom out"),text:"<span class='typcn typcn-minus mapTypIconButton'><\/span>"}),new OpenLayers.Control.Button({title:tr.translate("Search"),text:"<span class='typcn typcn-sort-alphabetically mapTypIconButton'><\/span>",trigger:function(){var t=gpsProvider.lastPos;t||(t=config.mapStartPos),n.openPlaceSearch()}}),new OpenLayers.Control.Button({title:tr.translate("Change map layer"),text:"<span class='typcn typcn-image mapTypIconButton'><\/span>",trigger:function(){n.nextMapLayer()}}),new OpenLayers.Control.Button({title:tr.translate("Cache result"),text:"<span class='typcn typcn-attachment mapTypIconButton'><\/span>",trigger:function(){n.addResultToCache()}})]),this.mapProvider.map.addControl(this.panel),t=new OpenLayers.Control.Clickhold({autoActivate:!0}),t.events.register("click",{},function(t){var i=n.mapProvider.getPosFromPx(t.xy);searchController.searchCriteria.pos(new System.Models.Position(i.lat,i.lon)),searchController.doSearch()}),t.events.register("clickhold",{},function(t){var i=n.mapProvider.getPosFromPx(t.xy);searchController.searchCriteria.pos(new System.Models.Position(i.lat,i.lon)),searchController.doSearch()}),this.mapProvider.map.addControl(t)},t.prototype.addResultToCache=function(){var n=$("#mapResultToRouteDialog"),t=n,i=$("<div><b>"+tr.translate("Name of new route")+":<\/b><br/><div class='nobr'><input type='input' id='mapResultToRouteName' /><\/div><\/div>"),r=$("<input type='button' value='"+tr.translate("Create")+"' />");r.mousedown(function(){var n=$("#mapResultToRouteName").val();n&&(routeController.addSearchRoute(n,searchController.latestSearchResult.items()),userPopupController.sendSuccess(tr.translate("Route created"),tr.translate("The route '{0}' was created.",[n])),t.dialog("close"))}),i.append(r),n.html(""),n.append(i),t.dialog({autoOpen:!0,maxWidth:"90%",maxHeight:"90%",modal:!0})},t.prototype.nextMapLayer=function(){var r=this.mapProvider.mapType,t=null,n=!1,i=this;$.each(settings.mapTypes(),function(u,f){t||(t=f.id),n&&(n=!1,i.mapProvider.changeLayer(f.id)),f.id==r&&(n=!0)}),n&&(n=!1,i.mapProvider.changeLayer(t))},t.prototype.openPlaceSearch=function(){var i=this,r=$("#mapSearchDialog"),u=$("#mapSearchDialog"),f="<input id='mapSearchInputBox' type='text' /><input id='mapSearchCommit' type='button' value='"+tr.translate("Search")+"' /><br/><div id='mapSearchResult'><\/div>",n,t;u.html(f),n=$("#mapSearchCommit"),t=$("#mapSearchInputBox"),n.mousedown(this.searchClick),t.keypress(function(n){n.which==13&&i.searchClick(null)}),r.dialog({autoOpen:!0,maxWidth:$(window).width()-50,maxHeight:$(window).height()-50,width:$(window).width()-50,height:$(window).height()-50,modal:!0})},t.prototype.searchClick=function(){var u=$("#mapSearchDialog"),t=$("#mapSearchResult"),f=$("#mapSearchInputBox"),i,r;t.html(""),i=f.val(),r=new n.SearchProviders.SSRSearch,t.html(""),r.search(i,function(n){$.each(n.items,function(n,i){var r=$("<div>").append("<h2>"+i.stedsnavn()+"<\/h2>["+i.navnetype()+"] "+i.fylkesnavn()+" / "+i.kommunenavn()).mousedown(function(){mapController.mapProvider.setCenter(i.pos,settings.startMapZoomLevel()),searchController.searchCriteria.pos(i.pos),searchController.doSearch(),u.dialog("close")});t.append(r)})},function(n){log.error("MapController","Error searching SSR: "+n),log.userPopup("SSR feil","Feil ved søk i stedsnavnregisteret.")})},t.prototype.renderView=function(n,t){log.debug("MapController","renderView()"),n.mapProvider.clearMarkers();var i=!0;$.each(t.items(),function(t,r){try{i&&(n.mapProvider.setCenter(r.pos()),i=!1),n.mapProvider.addMarker(r,function(){log.debug("Map","Clicked "+r.id()),poiController.OpenPreview(r,!0)})}catch(u){log.debug("MapController","Error on addMarker: "+r.name()+": "+u)}})},t}();t.MapController=i})(n.Controllers||(n.Controllers={}));var t=n.Controllers})(App||(App={})),mapController=new App.Controllers.MapController,startup.addPreInit(function(){mapController.PreInit()},"MapController"),startup.addInit(function(){mapController.Init()},"MapController")