var App;(function(n){(function(t){var i=function(){function t(){this.searchHalted=!1,this.combinedSearchResult=null,this.numSearchProviders=0,this.numSearchSuccess=0,this.numSearchError=0,this.successCallback=null,this.errorCallback=null,this.isSearching=!1}return t.prototype.search=function(t,i,r){var u,s;log.debug("SearchProvider","Searching: DataSourceNorvegiana"),u=this,this.combinedSearchResult=new n.Models.SearchResult,this.successCallback=i,this.errorCallback=r,this.isSearching=!0;var o=!0,f=!0,e=!0;if(t.query()&&t.query()!=""&&t.query()!="*"&&t.query()!="%"&&(f=!1),t.category()&&t.category().length>0&&t.category()[0]!="*"&&(t.category()[0]!=config.digitakArkivetPropertyCategory&&(f=!1),e=!1),t.mediaType()&&t.mediaType().length>0&&t.mediaType()[0]!="TEXT"&&t.mediaType()[0]!="*"&&(f=!1,e=!1),t.genre()&&t.genre().length>0&&t.genre()!="*"&&(s=t.genre(),s!="fagdata"&&(f=!1,o=!1),s!="wikipedia"&&(e=!1)),this.numSearchProviders=0,o&&this.numSearchProviders++,f&&this.numSearchProviders++,e&&this.numSearchProviders++,this.numSearchProviders==0){log.error("SearchProvider","The given combination of search criterias results in 0 datasources to search."),userPopupController.sendError(tr.translate("No datasources"),tr.translate("Search criteria results in 0 datasources. Try modifying your search."));return}setTimeout(function(){u.checkTimeout()},config.searchTimeoutSeconds*1e3),o&&(new n.SearchProviders.DataSourceNorvegiana).search(t,function(n){log.debug("SearchProvider","DataSourceNorvegiana: successCallback"),u.successCombine(n)},function(n){log.debug("SearchProvider","DataSourceNorvegiana: errorCallback: "+n),u.errorCombine("Norvegiana",n)}),f&&(new n.SearchProviders.DataSourceDigitalarkivetProperty).search(t,function(n){log.debug("SearchProvider","DataSourceDigitalarkivetProperty: successCallback"),u.successCombine(n)},function(n){log.debug("SearchProvider","DataSourceDigitalarkivetProperty: errorCallback: "+n),u.errorCombine("Digitalarkivet",n)}),e&&(new n.SearchProviders.DataSourceWikiLocation).search(t,function(n){log.debug("SearchProvider","DataSourceWikiLocation: successCallback"),u.successCombine(n)},function(n){log.debug("SearchProvider","DataSourceWikiLocation: errorCallback: "+n),u.errorCombine("Wikipedia",n)})},t.prototype.haltSearch=function(){this.searchHalted=!0},t.prototype.returnSuccess=function(){this.sortAndFilterResult(this.combinedSearchResult),this.isSearching=!1,this.haltSearch(),this.successCallback(this.combinedSearchResult)},t.prototype.successCombine=function(n){if(this.numSearchSuccess++,!this.searchHalted){var t=this;$.each(n.items(),function(n,i){var o=i.iconGenreURL(),s=pointOfInterestTypeProvider.getGenre(i),r,u,f,e;s&&(o=s.icon||i.iconGenreURL()),i.iconGenreURL(o),r=i.iconCategoryURL(),u=pointOfInterestTypeProvider.getCategory(i),u&&(r=u.icon||i.iconCategoryURL()),i.iconCategoryURL(r),f=i.iconMediaTypeURL(),e=pointOfInterestTypeProvider.getMediaType(i),e&&(f=e.icon||i.iconMediaTypeURL()),i.iconMediaTypeURL(f),t.combinedSearchResult.items.push(i)}),n.numFound()&&this.combinedSearchResult.numFound(0+parseInt(this.combinedSearchResult.numFound())+parseInt(n.numFound())),n.singleMaxNum()<n.numFound()&&n.singleMaxNum(n.numFound()),this.numSearchSuccess+this.numSearchError>=this.numSearchProviders&&this.returnSuccess()}},t.prototype.errorCombine=function(n,t){(this.numSearchError++,this.searchHalted)||(t!="Not Found"&&log.userPopup(tr.translate("Error searching"),tr.translate("Error searching")+" ("+n+"): "+t),this.numSearchSuccess+this.numSearchError>=this.numSearchProviders&&this.returnSuccess())},t.prototype.checkTimeout=function(){if(!this.searchHalted&&this.isSearching){var n=0+this.numSearchError+this.numSearchSuccess;log.error("Timeout","Timeout while searching all datasources: "+n+" of "+this.numSearchProviders+" sources responded so far. Halting search."),log.userPopup(tr.translate("TIMEOUT"),tr.translate("TIMEOUT_SEARCH_TOTAL",[n,this.numSearchProviders])),this.returnSuccess()}},t.prototype.sortAndFilterResult=function(n){var t=null;return gpsProvider.lastPos!=null&&(t=new LatLon(gpsProvider.lastPos.lat(),gpsProvider.lastPos.lon())),t!=null&&($.each(n.items(),function(n,i){if(i&&i.pos()&&i.pos().lat()&&i.pos().lon()){var r=new LatLon(i.pos().lat(),i.pos().lon());i.lastKnownDistanceMeter(t.distanceTo(r)*1e3)}}),n.items.sort(this.distanceSortFunction)),n},t.prototype.distanceSortFunction=function(n,t){return n.lastKnownDistanceMeter()-t.lastKnownDistanceMeter()},t}();t.SearchProvider=i})(n.Providers||(n.Providers={}));var t=n.Providers})(App||(App={}))