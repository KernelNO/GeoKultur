var System,mapCacheProvider;(function(n){(function(n){var t=function(){function n(){}return n.prototype.addCacheToMap=function(n,t){var r=new OpenLayers.Control.CacheReadCustom,i;t.addControl(r),r.cachingType=n,i=new OpenLayers.Control.CacheWriteCustom({autoActivate:!0,imageFormat:"image/jpeg",eventListeners:{cachefull:function(){log.error("MapProvider","Cache full.")}}}),i.cachingType=n,t.addControl(i)},n}();n.MapCacheProvider=t,OpenLayers.Control.CacheReadCustom=OpenLayers.Class(OpenLayers.Control,{fetchEvent:"tileloadstart",cachingType:"standard",layers:null,autoActivate:!0,setMap:function(n){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var i=this.layers||n.layers,t=i.length-1;t>=0;--t)this.addLayer({layer:i[t]});if(!this.layers)n.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(n){n.layer.events.register(this.fetchEvent,this,this.fetch)},removeLayer:function(n){n.layer.events.unregister(this.fetchEvent,this,this.fetch)},fetch:function(n){var t,i,r;this.active&&n.tile instanceof OpenLayers.Tile.Image&&(t=n.tile,i=t.url,!t.layer.crossOriginKeyword&&OpenLayers.ProxyHost&&i.indexOf(OpenLayers.ProxyHost)===0&&(i=OpenLayers.Control.CacheWriteCustom.urlMap[i]),r=mapStorageProvider.get(this.cachingType,"olCache_"+i),r&&(t.url=r,n.type==="tileerror"&&t.setImgSrc(r)))},destroy:function(){if(this.layers||this.map)for(var t=this.layers||this.map.layers,n=t.length-1;n>=0;--n)this.removeLayer({layer:t[n]});this.map&&this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.CacheReadCustom"}),OpenLayers.Control.CacheWriteCustom=OpenLayers.Class(OpenLayers.Control,{layers:null,tileLoadErrorBuffer:[],cachingType:"standard",imageFormat:"image/png",quotaRegEx:/quota/i,setMap:function(n){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var i=this.layers||n.layers,t=i.length-1;t>=0;--t)this.addLayer({layer:i[t]});if(!this.layers)n.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(n){n.layer.events.on({tileloadstart:this.makeSameOrigin,tileloaded:this.onTileloaded,scope:this})},removeLayer:function(n){n.layer.events.un({tileloadstart:this.makeSameOrigin,tileloaded:this.onTileloaded,scope:this})},makeSameOrigin:function(n){var t,i;this.active&&(t=n.tile,t instanceof OpenLayers.Tile.Image&&!t.crossOriginKeyword&&t.url.substr(0,5)!=="data:"&&(i=OpenLayers.Request.makeSameOrigin(t.url,OpenLayers.ProxyHost),OpenLayers.Control.CacheWriteCustom.urlMap[i]=t.url,t.url=i))},onTileloaded:function(n){this.active&&!n.aborted&&n.tile instanceof OpenLayers.Tile.Image&&n.tile.url.substr(0,5)!=="data:"&&(this.cache({tile:n.tile}),delete OpenLayers.Control.CacheWrite.urlMap[n.tile.url])},cache:function(n){var t=n.tile,i,r,e,f;try{i=t.getCanvasContext(),i&&(r=OpenLayers.Control.CacheWriteCustom.urlMap,e=r[t.url]||t.url,mapStorageProvider.set(this.cachingType,"olCache_"+e,i.canvas.toDataURL(this.imageFormat)),delete r[t.url])}catch(u){f=u.name||u.message,f&&this.quotaRegEx.test(f)?this.events.triggerEvent("cachefull",{tile:t}):OpenLayers.Console.error(u.toString())}},destroy:function(){if(this.layers||this.map)for(var t=this.layers||this.map.layers,n=t.length-1;n>=0;--n)this.removeLayer({layer:t[n]});this.map&&this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.CacheWriteCustom"}),OpenLayers.Control.CacheWriteCustom.clearCache=function(){mapStorageProvider.clear(this.cachingType)},OpenLayers.Control.CacheWriteCustom.urlMap={}})(n.Providers||(n.Providers={}));var t=n.Providers})(System||(System={})),mapCacheProvider=new System.Providers.MapCacheProvider