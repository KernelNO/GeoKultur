var System,mapPreCacheProvider;(function(n){(function(t){var r=function(){function n(n,t,i,r){this.mapProvider=n,this.pos=t,this.zoomLevel=i,this.buffer=r}return n}(),i;t.MapPreCacheQueueItem=r,i=function(){function t(){this.preCacheQueue=[],this.runningPreCaches=0,this.mapProvider=null,this.mapLayer=null,this.isProcessing=!1}return t.prototype.Init=function(){var t=this;$("body").append('<div id="preCacheMap" style="height: 256px; width: 256px; position: absolute; top: -1000; left: -1000;"><\/div>'),this.mapProvider=new n.Providers.MapProvider,this.mapProvider.Init(!0,"preCacheMap",null),mapCacheProvider.addCacheToMap("precache",this.mapProvider.map),setInterval(function(){t.processPreCacheQueue()},500)},t.prototype.processPreCacheQueue=function(){if(this.preCacheQueue.length==0){this.isProcessing&&(log.userPopup(translater.translate("PreCache"),translater.translate("Done precaching")),this.isProcessing=!1);return}if(this.runningPreCaches<1){var n=this.preCacheQueue.shift();this.doCachePos(n)}},t.prototype.addPreCacheLayer=function(n){typeof n=="undefined"&&(n=0),log.debug("MaPPreCacheProvider","Setting up cache layer.");var t=new OpenLayers.Strategy.Fixed;t.preload=!0,this.mapLayer=this.mapProvider.createLayer(config.mapCacheMapType,[t],n),this.mapLayer.setVisibility(!1),this.mapProvider.map.addLayer(this.mapLayer),this.mapProvider.map.setLayerIndex(this.mapLayer,10)},t.prototype.removePreCacheLayer=function(){log.debug("MaPPreCacheProvider","Disposing cache layer."),this.mapProvider.map.removeLayer(this.mapLayer),this.mapLayer=null},t.prototype.cachePos=function(t){var i=this,r;typeof t=="function"&&(t=t()),r=t.lat()+", "+t.lon(),log.debug("MapPreCacheProvider","Added "+r+" to precache queue."),$.each(config.mapCacheLevelDetail,function(r,u){i.isProcessing=!0;var f=new n.Providers.MapPreCacheQueueItem(i.mapProvider,t,r,u.surroundingTiles);i.preCacheQueue.push(f)})},t.prototype.doCachePos=function(n){var t,i;this.mapLayer||this.addPreCacheLayer(n.buffer),t=n.pos.lat()+", "+n.pos.lon(),log.debug("MapPreCacheProvider","Precaching "+t+""),i=this,this.mapLayer.clearGrid(),this.mapLayer.events.register("loadstart",this.mapLayer,function(){log.debug("MapPreCacheProvider",t+": Starting precache")}),this.mapLayer.events.register("tileloaded",this.mapLayer,function(){log.debug("MapPreCacheProvider",t+": Tile precached. "+this.numLoadingTiles+" left.")}),this.mapLayer.events.register("loadend",this.mapLayer,function(){log.debug("MapPreCacheProvider",t+": Precache End. Grid:"+this.grid.length+"x"+this.grid[0].length),i.removePreCacheLayer(),i.runningPreCaches--}),n.mapProvider.setCenter(n.pos,n.zoomLevel),this.runningPreCaches++},t}(),t.MapPreCacheProvider=i})(n.Providers||(n.Providers={}));var t=n.Providers})(System||(System={})),mapPreCacheProvider=new System.Providers.MapPreCacheProvider,startup.addInit(function(){mapPreCacheProvider.Init()})